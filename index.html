<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Charger Motor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --primary:#2563eb;
  --success:#16a34a;
  --warning:#f59e0b;
  --danger:#ef4444;
  --muted:#64748b;
  --bg:#f1f5f9;
  --card:#ffffff;
  --border:#e2e8f0;
}

* { box-sizing:border-box; }

body {
  margin:0;
  font-family:"Inter","Segoe UI",system-ui,sans-serif;
  background:var(--bg);
  min-height:100vh;
  padding:16px;
}

.container {
  max-width:1200px;
  margin:auto;
}

/* HEADER */
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:18px;
}
.header h1 {
  margin:0;
  font-size:22px;
}
.header p {
  margin:4px 0 0;
  color:var(--muted);
  font-size:14px;
}

/* BUTTONS */
.actions {
  display:flex;
  gap:10px;
}
button {
  padding:12px 18px;
  border-radius:14px;
  border:none;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}
button:active { transform:scale(.97); }

.btn-next { background:var(--success); color:white; }
.btn-skip { background:var(--warning); color:white; }
.btn-reset { background:var(--danger); color:white; }

/* GRID */
.grid {
  display:grid;
  grid-template-columns:1fr 2fr;
  gap:16px;
}

/* CARD */
.card {
  background:var(--card);
  border-radius:20px;
  padding:20px;
  box-shadow:0 15px 35px rgba(0,0,0,.08);
}

/* CURRENT */
.current h2 {
  margin-top:0;
  font-size:18px;
}
.current-number {
  font-size:44px;
  font-weight:800;
  color:var(--success);
}
.current-info {
  margin-top:10px;
  font-size:15px;
}

/* FILTER */
.filter {
  display:flex;
  gap:8px;
  margin-bottom:12px;
}
.filter button {
  padding:8px 14px;
  border-radius:999px;
  background:#e5e7eb;
  color:#111827;
  font-size:13px;
}
.filter button.active {
  background:var(--primary);
  color:white;
}

/* LIST */
.item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  border-radius:14px;
  background:#f8fafc;
  margin-bottom:10px;
}
.item b {
  font-size:15px;
}

.badge {
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}
.badge.now { background:#dcfce7; color:var(--success); }
.badge.ready { background:#fef3c7; color:var(--warning); }
.badge.wait { background:#e5e7eb; color:var(--muted); }

.empty {
  text-align:center;
  color:var(--muted);
  padding:20px;
  font-size:14px;
}
</style>
</head>

<body>

<div class="container">

  <div class="header">
    <div>
      <h1>ðŸ”Œ Admin Charger Motor</h1>
      <p>Kelola antrian charging</p>
    </div>
    <div class="actions">
      <button class="btn-next" onclick="nextQueue()">NEXT</button>
      <button class="btn-skip" onclick="skipQueue()">SKIP</button>
      <button class="btn-reset" onclick="resetQueue()">RESET</button>
    </div>
  </div>

  <div class="grid">

    <!-- CURRENT -->
    <div class="card current">
      <h2>Sedang Charging</h2>
      <div class="current-number" id="currentNumber">-</div>
      <div class="current-info" id="currentInfo">Belum ada</div>
    </div>

    <!-- LIST -->
    <div class="card">
      <h2>Antrian</h2>

      <div class="filter">
        <button onclick="setFilter('all')" class="active" id="f-all">Semua</button>
        <button onclick="setFilter('now')" id="f-now">Sekarang</button>
        <button onclick="setFilter('ready')" id="f-ready">Bersiap</button>
        <button onclick="setFilter('wait')" id="f-wait">Menunggu</button>
      </div>

      <div id="queueList" class="empty">Memuat data...</div>
    </div>

  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ========== FIREBASE ========== */
firebase.initializeApp({
  apiKey: "AIzaSyCIdveFrv0s1sD4N1sID8x0DH2RKgo5LJg",
  authDomain: "queue-charge.firebaseapp.com",
  projectId: "queue-charge"
});
const db = firebase.firestore();

/* ========== STATE ========== */
let currentNumber = 0;
let queueData = [];
let filter = "all";

/* ========== REALTIME META ========== */
db.collection("meta").doc("state").onSnapshot(doc => {
  currentNumber = doc.exists ? doc.data().current : 0;
  render();
});

/* ========== REALTIME QUEUE (ANTI INDEX) ========== */
db.collection("queue").onSnapshot(snapshot => {
  queueData = snapshot.docs.map(d => d.data())
    .sort((a,b) => a.number - b.number);
  render();
});

/* ========== RENDER ========== */
function render() {
  renderCurrent();
  renderList();
}

function renderCurrent() {
  const current = queueData.find(q => q.number === currentNumber);
  const numEl = document.getElementById("currentNumber");
  const infoEl = document.getElementById("currentInfo");

  if (!current) {
    numEl.innerText = "-";
    infoEl.innerText = "Belum ada";
    return;
  }

  numEl.innerText = "#" + current.number;
  infoEl.innerHTML = `<b>${current.name}</b><br>${current.plate}`;
}

function renderList() {
  const list = document.getElementById("queueList");
  list.innerHTML = "";

  let filtered = queueData.filter(q => {
    if (filter === "now") return q.number === currentNumber;
    if (filter === "ready") return q.number === currentNumber + 1;
    if (filter === "wait") return q.number > currentNumber + 1;
    return true;
  });

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty">Tidak ada data</div>`;
    return;
  }

  filtered.forEach(q => {
    let status="MENUNGGU", cls="wait";
    if (q.number === currentNumber) { status="SEKARANG"; cls="now"; }
    else if (q.number === currentNumber + 1) { status="BERSIAP"; cls="ready"; }

    const div = document.createElement("div");
    div.className="item";
    div.innerHTML=`
      <div>
        <b>#${q.number}</b><br>
        ${q.name} â€“ ${q.plate}
      </div>
      <span class="badge ${cls}">${status}</span>
    `;
    list.appendChild(div);
  });
}

/* ========== ACTIONS ========== */
async function nextQueue() {
  await db.collection("meta").doc("state")
    .set({ current: currentNumber + 1 });
}

async function skipQueue() {
  if (!confirm("Lewati antrian sekarang?")) return;
  await db.collection("meta").doc("state")
    .set({ current: currentNumber + 1 });
}

async function resetQueue() {
  if (!confirm("RESET SEMUA ANTRIAN?")) return;

  const snap = await db.collection("queue").get();
  const batch = db.batch();
  snap.docs.forEach(d => batch.delete(d.ref));
  await batch.commit();

  await db.collection("meta").doc("state").set({ current: 0 });
}

/* ========== FILTER ========== */
function setFilter(f) {
  filter = f;
  document.querySelectorAll(".filter button")
    .forEach(b => b.classList.remove("active"));
  document.getElementById("f-"+f).classList.add("active");
  renderList();
}
</script>

</body>
</html>
